<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¸°í›„ íŒë…ê¸° (ì—…ë¡œë“œ)</title>
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      text-align: center;
    }
    /* íŒŒì¼ ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë° ìˆ¨ê¹€ ì²˜ë¦¬ */
    input[type="file"] {
      display: none;
    }
    .upload-btn {
      display: inline-block;
      padding: 8px 16px;
      background-color: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 1em;
    }
    /* ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    #previewBox {
      width: 300px;
      height: 300px;
      border: 2px dashed #ccc;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      color: #ccc;
      position: relative;
    }
    /* ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    #previewBox img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }
    /* ê²°ê³¼ ì°¨íŠ¸ ì˜ì—­ */
    #resultChart {
      max-width: 600px;
      margin: 20px auto;
    }
    /* ìµœì¢… ê²°ê³¼ í…ìŠ¤íŠ¸ */
    #finalResult {
      font-size: 1.3em;
      margin-top: 20px;
    }
    /* ë¶„ì„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #analyzeBtn {
      display: inline-block;
      padding: 8px 16px;
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ ê¸°í›„ íŒë…ê¸°</h1>
  <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•œ í›„ â€œë¶„ì„í•˜ê¸°â€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

  <!-- íŒŒì¼ ì„ íƒ ë²„íŠ¼ -->
  <label for="upload" class="upload-btn">íŒŒì¼ ì„ íƒ</label>
  <input type="file" id="upload" accept="image/*" />

  <!-- ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ -->
  <div id="previewBox">?</div>

  <!-- ë¶„ì„ ë²„íŠ¼ -->
  <div>
    <button id="analyzeBtn">ë¶„ì„í•˜ê¸°</button>
  </div>

  <!-- ì˜ˆì¸¡ ê²°ê³¼ ì°¨íŠ¸ -->
  <canvas id="resultChart"></canvas>

  <!-- ì˜ˆì¸¡ ê²°ê³¼ í…ìŠ¤íŠ¸ -->
  <div id="finalResult"></div>

  <script>
    // Teachable Machine ëª¨ë¸ ë° ë©”íƒ€ë°ì´í„° URL (ë§ˆì§€ë§‰ ìŠ¬ë˜ì‹œ í¬í•¨)
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/fKOt3kD2E/";
    const MODEL_JSON = MODEL_URL + "model.json";
    const METADATA_JSON = MODEL_URL + "metadata.json";

    let model, classLabels;
    const uploadInput = document.getElementById("upload");
    const previewBox = document.getElementById("previewBox");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultCtx = document.getElementById("resultChart").getContext('2d');
    const finalResult = document.getElementById("finalResult");
    let chart;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë¸ê³¼ ë¼ë²¨ ë¡œë“œ
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        // LayersModel í˜•ì‹ìœ¼ë¡œ ë¡œë“œ
        model = await tf.loadLayersModel(MODEL_JSON);
        const metadata = await fetch(METADATA_JSON).then(res => res.json());
        classLabels = metadata.labels;
        console.log("âœ… ëª¨ë¸ ë° ë¼ë²¨ ë¡œë”© ì™„ë£Œ");
      } catch (err) {
        console.error("âŒ ë¡œë”© ì¤‘ ì˜¤ë¥˜:", err);
        alert("ëª¨ë¸ ë˜ëŠ” ë©”íƒ€ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.");
      }
    });

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬ ë° ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
    uploadInput.addEventListener("change", () => {
      const file = uploadInput.files[0];
      if (!file) return;
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.onload = () => {
        // ê¸°ì¡´ ìš”ì†Œ ì •ë¦¬
        previewBox.innerHTML = '';
        previewBox.appendChild(img);
        img.style.display = 'block';
        // ê²°ê³¼ ì´ˆê¸°í™”
        if (chart) chart.destroy();
        finalResult.innerText = '';
      };
    });

    // ë¶„ì„ ë²„íŠ¼ í´ë¦­ ì‹œ ì˜ˆì¸¡ ì‹¤í–‰
    analyzeBtn.addEventListener("click", async () => {
      // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ìš”ì†Œ ì°¾ê¸°
      const img = previewBox.querySelector('img');
      if (!img) {
        return alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
      }
      if (!model || !classLabels) {
        return alert("ëª¨ë¸ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
      }
      try {
        // ì „ì²˜ë¦¬: resize, normalize, expandDims
        const tensor = tf.browser.fromPixels(img)
          .resizeNearestNeighbor([224, 224])
          .toFloat()
          .div(tf.scalar(255.0))
          .expandDims();

        // ì˜ˆì¸¡
        const predictionTensor = model.predict(tensor);
        const data = await predictionTensor.data();

        // ë©”ëª¨ë¦¬ í•´ì œ
        tensor.dispose();
        predictionTensor.dispose();

        // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        if (chart) chart.destroy();
        chart = new Chart(resultCtx, {
          type: 'bar',
          data: {
            labels: classLabels,
            datasets: [{ label: 'í™•ë¥  (%)', data: Array.from(data).map(v => v * 100) }]
          },
          options: { scales: { y: { beginAtZero: true, max: 100 } } }
        });

        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        const maxIdx = data.indexOf(Math.max(...data));
        const climate = classLabels[maxIdx];
        const percent = (data[maxIdx] * 100).toFixed(1);
        let emoji = '';
        if (climate === 'ì—´ëŒ€ê¸°í›„') emoji = 'â˜€ï¸';
        else if (climate === 'ê±´ì¡°ê¸°í›„') emoji = 'ğŸŒ´';
        else if (climate === 'ëƒ‰í•œëŒ€ê¸°í›„') emoji = 'â›„ï¸';
        finalResult.innerText = `${emoji} ìµœì¢… ì˜ˆì¸¡: ${climate} (${percent}%)`;
      } catch (err) {
        console.error("âŒ ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜:", err);
        alert("ì˜ˆì¸¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    });
  </script>
</body>
</html>
