<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸°í›„ê²½ê´€ íŒë…ê¸° (ì—…ë¡œë“œ)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      text-align: center;
    }
    input[type="file"] { display: none; }
    .upload-btn {
      display: inline-block;
      padding: 8px 16px;
      background-color: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 1em;
      margin-bottom: 8px;
    }
    #previewBox {
      width: 300px;
      height: 300px;
      border: 2px dashed #ccc;
      margin: 10px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      color: #ccc;
      position: relative;
      background: #fafafa;
      box-sizing: border-box;
      overflow: hidden;
    }
    #previewBox img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    #resultChart {
      max-width: 600px;
      margin: 20px auto;
    }
    #finalResult {
      font-size: 1.3em;
      margin-top: 20px;
      font-weight: bold;
    }
    #analyzeBtn, #resetBtn {
      display: inline-block;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 6px;
    }
    #analyzeBtn {
      background-color: #28a745;
      color: #fff;
    }
    #analyzeBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #resetBtn {
      background-color: #6c757d;
      color: #fff;
    }
    @media (max-width: 640px) {
      #previewBox {
        width: 90vw;
        max-width: 300px;
        height: auto;
        aspect-ratio: 1 / 1;
        font-size: 2.5em;
        padding: 5px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸŒ ê¸°í›„ê²½ê´€ íŒë…ê¸°</h1>
  <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•œ í›„ â€œë¶„ì„í•˜ê¸°â€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

  <div>
    <label for="upload" class="upload-btn">íŒŒì¼ ì„ íƒ</label>
    <input type="file" id="upload" accept="image/*" />
  </div>

  <div id="previewBox">?</div>

  <div>
    <button id="analyzeBtn" disabled>ë¶„ì„í•˜ê¸°</button>
    <button id="resetBtn">ì´ˆê¸°í™”</button>
  </div>

  <canvas id="resultChart"></canvas>
  <div id="finalResult"></div>

  <script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/fKOt3kD2E/";
    const MODEL_JSON = MODEL_URL + "model.json";
    const METADATA_JSON = MODEL_URL + "metadata.json";

    let model, classLabels;
    const uploadInput = document.getElementById("upload");
    const previewBox = document.getElementById("previewBox");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resetBtn = document.getElementById("resetBtn");
    const resultCtx = document.getElementById("resultChart").getContext('2d');
    const finalResult = document.getElementById("finalResult");
    let chart;

    let imageLoaded = false;
    let modelReady = false;
    let currentObjectURL = null;

    // ëª¨ë¸ê³¼ ë¼ë²¨ ë¡œë“œ
    async function loadModelAndLabels() {
      try {
        model = await tf.loadLayersModel(MODEL_JSON);
        const metadata = await fetch(METADATA_JSON).then(res => {
          if (!res.ok) throw new Error("metadata.json ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
          return res.json();
        });
        classLabels = metadata.labels;
        modelReady = true;
        updateAnalyzeState();
        console.log("âœ… ëª¨ë¸ ë° ë¼ë²¨ ë¡œë”© ì™„ë£Œ", classLabels);
      } catch (err) {
        console.error("ëª¨ë¸ ë˜ëŠ” ë©”íƒ€ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", err);
        alert("ëª¨ë¸ ë˜ëŠ” ë©”íƒ€ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLê³¼ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      }
    }

    loadModelAndLabels();

    function updateAnalyzeState() {
      analyzeBtn.disabled = !(modelReady && imageLoaded);
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    uploadInput.addEventListener("change", () => {
      const file = uploadInput.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        alert("ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      // ì´ì „ ì˜¤ë¸Œì íŠ¸ URL ì •ë¦¬
      if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
      currentObjectURL = URL.createObjectURL(file);

      const img = document.createElement('img');
      img.src = currentObjectURL;
      img.alt = "ì—…ë¡œë“œëœ ì´ë¯¸ì§€";
      img.onload = () => {
        previewBox.innerHTML = '';
        previewBox.appendChild(img);
        imageLoaded = true;
        finalResult.innerText = '';
        if (chart) chart.destroy();
        updateAnalyzeState();
      };
      img.onerror = () => {
        alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤.");
      };
    });

    // ë¶„ì„
    analyzeBtn.addEventListener("click", async () => {
      const img = previewBox.querySelector('img');
      if (!img) {
        alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!modelReady) {
        alert("ëª¨ë¸ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      try {
        // ì „ì²˜ë¦¬
        const tensor = tf.browser.fromPixels(img)
          .resizeNearestNeighbor([224, 224])
          .toFloat()
          .div(tf.scalar(255.0))
          .expandDims();

        const predictionTensor = model.predict(tensor);
        const data = await predictionTensor.data();

        tensor.dispose();
        predictionTensor.dispose();

        // ë§‰ëŒ€ê·¸ë˜í”„
        if (chart) chart.destroy();
        chart = new Chart(resultCtx, {
          type: 'bar',
          data: {
            labels: classLabels,
            datasets: [{
              label: 'í™•ë¥  (%)',
              data: Array.from(data).map(v => v * 100)
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, max: 100 }
            },
            plugins: { legend: { display: false } }
          }
        });

        const maxIdx = data.indexOf(Math.max(...data));
        const climate = classLabels[maxIdx];
        const percent = (data[maxIdx] * 100).toFixed(1);
        let emoji = '';
        if (climate === 'ì—´ëŒ€ê¸°í›„') emoji = 'â˜€ï¸';
        else if (climate === 'ê±´ì¡°ê¸°í›„') emoji = 'ğŸŒ´';
        else if (climate === 'ëƒ‰í•œëŒ€ê¸°í›„') emoji = 'â›„ï¸';
        finalResult.innerText = `${emoji} ìµœì¢… ì˜ˆì¸¡: ${climate} (${percent}%)`;
      } catch (err) {
        console.error("ì˜ˆì¸¡ ì˜¤ë¥˜:", err);
        alert("ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
      }
    });

    // ì´ˆê¸°í™”
    resetBtn.addEventListener("click", () => {
      // revoke and clear
      if (currentObjectURL) {
        URL.revokeObjectURL(currentObjectURL);
        currentObjectURL = null;
      }
      previewBox.innerHTML = '?';
      imageLoaded = false;
      updateAnalyzeState();
      if (chart) {
        chart.destroy();
        chart = null;
      }
      finalResult.innerText = '';
    });
  </script>
</body>
</html>
